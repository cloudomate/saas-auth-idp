# Traefik Dynamic Configuration - Headless Auth Mode

http:
  # Middlewares
  middlewares:
    # ForwardAuth middleware - validates requests through AuthZ service
    authz:
      forwardAuth:
        address: "http://authz:8002/gate"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-User-ID"
          - "X-User-Name"
          - "X-User-Email"
          - "X-Tenant-ID"
          - "X-Workspace-ID"
          - "X-Is-Admin"
          - "X-Is-Platform-Admin"
          - "Authorization"

    # CORS middleware
    cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - Authorization
          - Content-Type
          - X-Workspace-ID
        accessControlAllowOriginList:
          - "http://localhost:3000"
          - "http://localhost:3001"
          - "http://localhost:5173"
        accessControlAllowCredentials: true
        accessControlMaxAge: 100

    # Rate limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 50

  # Routers
  routers:
    # Main API routes (with auth)
    api:
      rule: "PathPrefix(`/api/v1`)"
      entryPoints:
        - web
      middlewares:
        - cors
        - authz
        - rate-limit
      service: sample-api

    # Health check (no auth)
    health:
      rule: "Path(`/health`)"
      entryPoints:
        - web
      service: sample-api

    # Casdoor API-only endpoints (headless mode - no UI)
    # JWKS for token verification
    casdoor-jwks:
      rule: "PathPrefix(`/.well-known`)"
      entryPoints:
        - web
      middlewares:
        - cors
      service: casdoor

    # Casdoor login API (password auth, token exchange)
    casdoor-auth-api:
      rule: "Path(`/api/login`) || Path(`/api/logout`) || Path(`/api/signup`) || Path(`/api/get-account`)"
      entryPoints:
        - web
      middlewares:
        - cors
        - rate-limit
      service: casdoor
      priority: 100

    # OAuth token endpoint
    casdoor-oauth-token:
      rule: "PathPrefix(`/api/login/oauth`)"
      entryPoints:
        - web
      middlewares:
        - cors
        - rate-limit
      service: casdoor
      priority: 100

  # Services
  services:
    sample-api:
      loadBalancer:
        servers:
          - url: "http://sample-api:8001"

    casdoor:
      loadBalancer:
        servers:
          - url: "http://casdoor:8000"
